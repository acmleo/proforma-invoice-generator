<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="在线Proforma Invoice生成器，可自定义发票内容并导出为图片">
    <meta name="keywords" content="发票生成器,Proforma Invoice,外贸发票,发票模板">
    <title>Proforma Invoice Generator | 在线发票生成器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 全局重置和基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --dark-color: #2c3e50;
            --light-color: #f8f9fa;
            --gray-color: #95a5a6;
            --border-color: #ddd;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Noto Sans SC', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px var(--shadow-color);
            overflow: hidden;
        }
        
        /* 头部样式 */
        header {
            background: linear-gradient(135deg, var(--primary-color), #2980b9);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
        }
        
        .logo h1 {
            font-size: 2.2rem;
            font-weight: 700;
        }
        
        .tagline {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* 主内容区域 */
        main {
            padding: 25px;
        }
        
        .app-description {
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid var(--primary-color);
        }
        
        .app-description h2 {
            color: var(--dark-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .app-description p {
            margin-bottom: 10px;
            color: #555;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .feature {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 3px 10px var(--shadow-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .feature i {
            font-size: 1.8rem;
            color: var(--primary-color);
        }
        
        .feature h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: var(--dark-color);
        }
        
        .feature p {
            font-size: 0.9rem;
            color: var(--gray-color);
        }
        
        /* 生成器主体 - 改为上下布局 */
        .generator-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .input-section, .preview-section {
            width: 100%;
        }
        
        .section-card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px var(--shadow-color);
            display: flex;
            flex-direction: column;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-color);
            color: var(--dark-color);
        }
        
        .section-title i {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .section-title h2 {
            font-size: 1.5rem;
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.95rem;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: 'Noto Sans SC', sans-serif;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }
        
        /* 汇率输入框样式 */
        .exchange-rate-container {
            background-color: #fff9e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            border-left: 4px solid #f39c12;
        }
        
        .exchange-rate-container h3 {
            color: #e67e22;
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .exchange-rate-container h3 i {
            color: #f39c12;
        }
        
        .exchange-rate-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .exchange-rate-input label {
            font-weight: 600;
            color: #d35400;
            white-space: nowrap;
        }
        
        .exchange-rate-input input {
            flex: 1;
            max-width: 200px;
            padding: 10px 15px;
            border: 1px solid #f1c40f;
            border-radius: 6px;
            font-size: 1rem;
            background-color: #fffdf0;
        }
        
        /* 产品部分样式 */
        .products-section {
            margin-top: 20px;
        }
        
        .product-item {
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-color);
            position: relative;
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .product-header h3 {
            font-size: 1.1rem;
            color: var(--dark-color);
            margin: 0;
        }
        
        .btn-delete {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
        }
        
        .btn-delete:hover {
            background-color: #c0392b;
        }
        
        /* 图片上传区域 */
        .image-upload-container {
            margin-top: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border: 1px dashed var(--border-color);
        }
        
        .image-upload-container h4 {
            margin-bottom: 10px;
            font-size: 0.95rem;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .image-upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px dashed var(--primary-color);
            border-radius: 6px;
            background-color: #f0f7ff;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .image-upload-area:hover {
            background-color: #e1f0ff;
            border-color: #2980b9;
        }
        
        .image-upload-area i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .image-upload-area p {
            color: #555;
            font-size: 0.9rem;
        }
        
        .image-upload-area input[type="file"] {
            display: none;
        }
        
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .image-preview-item {
            position: relative;
            width: 96px;
            height: 96px;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-image-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
            z-index: 10;
        }
        
        /* 按钮样式 */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-family: 'Noto Sans SC', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
        }
        
        .btn-add {
            background-color: #9b59b6;
            color: white;
            width: 100%;
            margin-bottom: 25px;
        }
        
        .btn-add:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(155, 89, 182, 0.3);
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .action-buttons .btn {
            flex: 1;
            min-width: 200px;
        }
        
        /* 加载指示器 */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--primary-color);
            font-weight: 600;
            margin-top: 15px;
        }
        
        .loading i {
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 预览区域样式 */
        .preview-container {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
            max-height: 600px;
            margin-top: 15px;
        }
        
        /* 为图片生成添加额外内边距 */
        .preview-container.printable {
            padding: 40px;
            background-color: #ffffff;
            border: 2px dashed #ddd;
        }
        
        .invoice-preview {
            font-family: Arial, sans-serif;
            font-size: 12px;
            line-height: 1.4;
            color: #333;
        }
        
        .invoice-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #333;
        }
        
        .company-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .company-address {
            font-size: 13px;
            color: #666;
        }
        
        .invoice-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 25px 0;
            text-decoration: underline;
        }
        
        .invoice-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding: 0 10px;
        }
        
        .invoice-info > div {
            margin-bottom: 8px;
        }
        
        .contact-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding: 0 10px;
        }
        
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 12px;
        }
        
        .invoice-table th, .invoice-table td {
            border: 1px solid #333;
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }
        
        .invoice-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .product-image-cell {
            text-align: center;
            width: 100px;
        }
        
        .product-image-cell img {
            max-width: 96px;
            max-height: 96px;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .total-section {
            text-align: right;
            margin: 25px 0;
            font-size: 15px;
            font-weight: bold;
            padding: 0 10px;
        }
        
        .exchange-rate-display {
            text-align: right;
            margin: 10px 0;
            font-size: 13px;
            color: #666;
            padding: 0 10px;
        }
        
        .terms-section {
            margin-top: 30px;
            font-size: 12px;
            line-height: 1.5;
            padding: 0 10px;
        }
        
        .bank-details {
            margin-top: 20px;
            font-size: 12px;
            line-height: 1.6;
            padding: 0 10px;
        }
        
        /* 页脚样式 */
        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 25px;
            text-align: center;
            margin-top: 40px;
        }
        
        .footer-content {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .footer-links a {
            color: #bdc3c7;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: white;
        }
        
        .copyright {
            margin-top: 20px;
            font-size: 0.9rem;
            color: #95a5a6;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .action-buttons .btn {
                min-width: 100%;
            }
            
            .logo h1 {
                font-size: 1.8rem;
            }
            
            .features {
                grid-template-columns: 1fr;
            }
            
            .section-card {
                padding: 15px;
            }
            
            .preview-container {
                max-height: 500px;
            }
            
            .exchange-rate-input {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .exchange-rate-input input {
                max-width: 100%;
                width: 100%;
            }
            
            .invoice-info, .contact-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .invoice-info > div, .contact-info > div {
                width: 100%;
            }
            
            .invoice-table {
                font-size: 10px;
            }
            
            .invoice-table th, .invoice-table td {
                padding: 6px;
            }
            
            .product-image-cell {
                width: 60px;
            }
            
            .product-image-cell img {
                max-width: 60px;
                max-height: 60px;
            }
        }
        
        /* GitHub角标 */
        .github-corner {
            position: absolute;
            top: 0;
            right: 0;
            z-index: 100;
        }
        
        .github-corner svg {
            fill: #151513;
            color: #fff;
            position: absolute;
            top: 0;
            border: 0;
            right: 0;
        }
        
        .github-corner:hover .octo-arm {
            animation: octocat-wave 560ms ease-in-out;
        }
        
        @keyframes octocat-wave {
            0%, 100% { transform: rotate(0); }
            20%, 60% { transform: rotate(-25deg); }
            40%, 80% { transform: rotate(10deg); }
        }
        
        @media (max-width: 500px) {
            .github-corner:hover .octo-arm { animation: none; }
            .github-corner .octo-arm { animation: octocat-wave 560ms ease-in-out; }
        }
    </style>
</head>
<body>
    <!-- GitHub角标 -->
    <a href="https://github.com" class="github-corner" aria-label="View source on GitHub" target="_blank">
        <svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true">
            <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
            <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
            <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
        </svg>
    </a>

    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-file-invoice-dollar"></i>
                <h1>Proforma Invoice Generator</h1>
            </div>
            <p class="tagline">在线外贸发票生成器 | 快速创建专业Proforma发票，支持导出为图片格式，适用于外贸、跨境电商等场景</p>
        </header>
        
        <main>
            <div class="app-description">
                <h2><i class="fas fa-info-circle"></i> 工具简介</h2>
                <p>这是一个免费的在线Proforma Invoice（形式发票）生成工具，帮助外贸从业者、跨境电商卖家快速创建专业的形式发票。所有数据均在本地处理，不会上传到服务器，保障您的数据安全。</p>
                
                <div class="features">
                    <div class="feature">
                        <i class="fas fa-mobile-alt"></i>
                        <div>
                            <h3>移动端友好</h3>
                            <p>完全响应式设计，在手机、平板和电脑上都能完美显示</p>
                        </div>
                    </div>
                    <div class="feature">
                        <i class="fas fa-download"></i>
                        <div>
                            <h3>一键导出</h3>
                            <p>将生成的发票导出为PNG图片，方便保存和分享</p>
                        </div>
                    </div>
                    <div class="feature">
                        <i class="fas fa-image"></i>
                        <div>
                            <h3>产品图片</h3>
                            <p>支持为每个产品上传图片，自动压缩为96px</p>
                        </div>
                    </div>
                    <div class="feature">
                        <i class="fas fa-shield-alt"></i>
                        <div>
                            <h3>数据安全</h3>
                            <p>所有数据在浏览器本地处理，不会上传到任何服务器</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="generator-container">
                <!-- 输入区域 -->
                <div class="input-section">
                    <div class="section-card">
                        <div class="section-title">
                            <i class="fas fa-edit"></i>
                            <h2>填写发票信息</h2>
                        </div>
                        
                        <div class="form-group">
                            <label for="toCompany">TO (买方公司):</label>
                            <input type="text" id="toCompany" class="form-control" value="Glow general trading PLC">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="invoiceDate">日期:</label>
                                <input type="date" id="invoiceDate" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="invoiceNumber">发票号:</label>
                                <input type="text" id="invoiceNumber" class="form-control" value="KEMEI-GLOW-20251208">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="attnName">Attn. 姓名:</label>
                                <input type="text" id="attnName" class="form-control" value="Rathanak">
                            </div>
                            <div class="form-group">
                                <label for="attnPhone">Attn. 电话:</label>
                                <input type="text" id="attnPhone" class="form-control" value="+885 85 294 362/+885 81 409 954">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sellerName">Seller 姓名:</label>
                                <input type="text" id="sellerName" class="form-control" value="Leo">
                            </div>
                            <div class="form-group">
                                <label for="sellerPhone">Seller 电话:</label>
                                <input type="text" id="sellerPhone" class="form-control" value="+86 180 2231 6636">
                            </div>
                        </div>
                        
                        <!-- 汇率输入区域 -->
                        <div class="exchange-rate-container">
                            <h3><i class="fas fa-exchange-alt"></i> 汇率设置</h3>
                            <div class="exchange-rate-input">
                                <label for="exchangeRate">美元兑人民币汇率 (USD/CNY):</label>
                                <input type="number" id="exchangeRate" class="form-control" step="0.01" min="0.01" value="7.08">
                            </div>
                            <p style="font-size: 0.85rem; color: #7f8c8d; margin-top: 8px;">
                                <i class="fas fa-info-circle"></i> 汇率用于将美元金额转换为人民币金额
                            </p>
                        </div>
                        
                        <div class="products-section">
                            <div class="section-title">
                                <i class="fas fa-boxes"></i>
                                <h2>产品信息</h2>
                            </div>
                            
                            <div id="productContainer">
                                <!-- 产品行将通过JS动态添加 -->
                            </div>
                            
                            <button type="button" id="addProductBtn" class="btn btn-add">
                                <i class="fas fa-plus"></i> 添加产品
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label for="shipmentTerms">发货条款:</label>
                            <textarea id="shipmentTerms" class="form-control" rows="2">EXW, Container will be loaded in Customer-designated freight forwarder address.</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="paymentTerms">付款条款:</label>
                            <textarea id="paymentTerms" class="form-control" rows="2">100% before shipment, bank charge will be covered by KEMEI</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="leadTime">交货时间:</label>
                            <input type="text" id="leadTime" class="form-control" value="10 days">
                        </div>
                        
                        <div class="action-buttons">
                            <button type="button" id="updatePreviewBtn" class="btn btn-primary">
                                <i class="fas fa-sync-alt"></i> 更新预览
                            </button>
                            <button type="button" id="downloadInvoiceBtn" class="btn btn-success">
                                <i class="fas fa-download"></i> 下载为图片
                            </button>
                        </div>
                        
                        <div id="loadingIndicator" class="loading">
                            <i class="fas fa-spinner fa-spin"></i> 正在生成图片，请稍候...
                        </div>
                    </div>
                </div>
                
                <!-- 预览区域 - 放在下方 -->
                <div class="preview-section">
                    <div class="section-card">
                        <div class="section-title">
                            <i class="fas fa-eye"></i>
                            <h2>发票预览</h2>
                        </div>
                        
                        <div class="preview-container" id="previewContainer">
                            <div id="invoicePreview" class="invoice-preview">
                                <!-- 预览内容将通过JS动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer>
            <div class="footer-content">
                <p>Proforma Invoice Generator | 在线发票生成工具</p>
                <div class="footer-links">
                    <a href="#"><i class="fas fa-question-circle"></i> 使用帮助</a>
                    <a href="#"><i class="fas fa-bug"></i> 报告问题</a>
                    <a href="#"><i class="fas fa-code"></i> GitHub</a>
                    <a href="#"><i class="fas fa-envelope"></i> 联系我们</a>
                </div>
                <div class="copyright">
                    &copy; 2023 Proforma Invoice Generator. 本工具仅供个人和企业内部使用，不存储任何用户数据。
                </div>
            </div>
        </footer>
    </div>

    <!-- 引入html2canvas库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
    // 发票生成器主逻辑
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Proforma Invoice Generator 正在初始化...');
        
        // 设置默认日期为今天
        const today = new Date();
        const formattedToday = today.toISOString().split('T')[0];
        document.getElementById('invoiceDate').value = formattedToday;
        
        // 初始产品数据
        const initialProducts = [
            { 
                no: 1, 
                model: "4300", 
                pic: "printed paper", 
                itemName: "printed paper", 
                specification: "", 
                exw: "1.9", 
                qty: "1,040", 
                units: "KG", 
                amount: "1,976", 
                remark: "20KG/roll",
                images: []
            },
            { 
                no: 2, 
                model: "H64087J", 
                pic: "printed paper", 
                itemName: "printed paper", 
                specification: "", 
                exw: "1.9", 
                qty: "520", 
                units: "KG", 
                amount: "988", 
                remark: "20KG/roll",
                images: []
            },
            { 
                no: 3, 
                model: "4342", 
                pic: "printed paper", 
                itemName: "printed paper", 
                specification: "", 
                exw: "1.9", 
                qty: "520", 
                units: "KG", 
                amount: "988", 
                remark: "20KG/roll",
                images: []
            },
            { 
                no: 4, 
                model: "Freight cost", 
                pic: "printed paper", 
                itemName: "printed paper", 
                specification: "shipped from Foshan City to Linyi, Shandong Province, with a distance of 1,400 kilometers", 
                exw: "0.076", 
                qty: "2,080", 
                units: "KG", 
                amount: "158", 
                remark: "4 ROLL",
                images: []
            }
        ];
        
        const productContainer = document.getElementById('productContainer');
        let productCount = initialProducts.length;
        
        // 添加初始产品
        initialProducts.forEach(product => {
            addProductRow(product);
        });
        
        // 绑定事件
        document.getElementById('addProductBtn').addEventListener('click', function() {
            productCount++;
            addProductRow({
                no: productCount,
                model: "",
                pic: "",
                itemName: "",
                specification: "",
                exw: "",
                qty: "",
                units: "",
                amount: "",
                remark: "",
                images: []
            });
        });
        
        document.getElementById('updatePreviewBtn').addEventListener('click', updateInvoicePreview);
        document.getElementById('downloadInvoiceBtn').addEventListener('click', downloadInvoiceAsImage);
        
        // 初始化预览
        updateInvoicePreview();
        
        // 图片压缩函数
        function compressImage(file, maxWidth = 96, maxHeight = 96, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                
                reader.onload = function(event) {
                    const img = new Image();
                    img.src = event.target.result;
                    
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // 计算缩放比例
                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round(height * maxWidth / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round(width * maxHeight / height);
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // 转换为base64
                        const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedBase64);
                    };
                    
                    img.onerror = reject;
                };
                
                reader.onerror = reject;
            });
        }
        
        // 添加产品行函数
        function addProductRow(product) {
            const productRow = document.createElement('div');
            productRow.className = 'product-item';
            productRow.dataset.index = product.no;
            
            productRow.innerHTML = `
                <div class="product-header">
                    <h3>产品 #${product.no}</h3>
                    <button type="button" class="btn-delete">
                        <i class="fas fa-trash"></i> 删除
                    </button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>型号 (Model):</label>
                        <input type="text" class="form-control product-model" value="${escapeHtml(product.model)}">
                    </div>
                    <div class="form-group">
                        <label>PIC:</label>
                        <input type="text" class="form-control product-pic" value="${escapeHtml(product.pic)}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>产品名称 (Item Name):</label>
                        <input type="text" class="form-control product-item-name" value="${escapeHtml(product.itemName)}">
                    </div>
                    <div class="form-group">
                        <label>规格 (Specification):</label>
                        <input type="text" class="form-control product-specification" value="${escapeHtml(product.specification)}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>EXW USD:</label>
                        <input type="text" class="form-control product-exw" value="${escapeHtml(product.exw)}">
                    </div>
                    <div class="form-group">
                        <label>数量 (Q'TY):</label>
                        <input type="text" class="form-control product-qty" value="${escapeHtml(product.qty)}">
                    </div>
                    <div class="form-group">
                        <label>单位 (Units):</label>
                        <input type="text" class="form-control product-units" value="${escapeHtml(product.units)}">
                    </div>
                    <div class="form-group">
                        <label>金额 (Amount USD):</label>
                        <input type="text" class="form-control product-amount" value="${escapeHtml(product.amount)}">
                    </div>
                </div>
                <div class="form-group">
                    <label>备注 (Remark):</label>
                    <input type="text" class="form-control product-remark" value="${escapeHtml(product.remark)}">
                </div>
                <div class="image-upload-container">
                    <h4><i class="fas fa-images"></i> 产品图片 (可选)</h4>
                    <div class="image-upload-area" id="uploadArea-${product.no}">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>点击或拖放图片到这里上传</p>
                        <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">支持JPG、PNG格式，图片将被压缩为96px</p>
                        <input type="file" class="product-image-input" accept="image/*" multiple>
                    </div>
                    <div class="image-preview-container" id="imagePreview-${product.no}">
                        ${product.images && product.images.length > 0 ? product.images.map((img, index) => `
                            <div class="image-preview-item">
                                <img src="${img}" alt="产品图片 ${index + 1}">
                                <button type="button" class="remove-image-btn" data-index="${index}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('') : ''}
                    </div>
                </div>
            `;
            
            productContainer.appendChild(productRow);
            
            // 添加删除按钮事件
            const deleteBtn = productRow.querySelector('.btn-delete');
            deleteBtn.addEventListener('click', function() {
                if (confirm('确定要删除这个产品吗？')) {
                    productRow.remove();
                    productCount--;
                    // 重新编号所有产品
                    const productRows = productContainer.querySelectorAll('.product-item');
                    productRows.forEach((row, index) => {
                        const header = row.querySelector('.product-header h3');
                        if (header) {
                            header.textContent = `产品 #${index + 1}`;
                        }
                    });
                }
            });
            
            // 获取上传区域和预览容器
            const uploadArea = productRow.querySelector(`#uploadArea-${product.no}`);
            const fileInput = productRow.querySelector('.product-image-input');
            const imagePreviewContainer = productRow.querySelector(`#imagePreview-${product.no}`);
            
            // 存储该产品的图片数据
            productRow.productImages = product.images || [];
            
            // 点击上传区域触发文件选择
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // 拖放功能
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = '#d9ecff';
                uploadArea.style.borderColor = '#2980b9';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.backgroundColor = '#f0f7ff';
                uploadArea.style.borderColor = 'var(--primary-color)';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = '#f0f7ff';
                uploadArea.style.borderColor = 'var(--primary-color)';
                
                if (e.dataTransfer.files.length) {
                    handleImageUpload(e.dataTransfer.files, productRow, imagePreviewContainer);
                }
            });
            
            // 文件选择变化
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleImageUpload(e.target.files, productRow, imagePreviewContainer);
                    // 清空文件输入，以便可以再次选择相同的文件
                    e.target.value = '';
                }
            });
            
            // 处理图片上传
            async function handleImageUpload(files, productRow, previewContainer) {
                const maxImages = 5; // 每个产品最多上传5张图片
                const currentCount = productRow.productImages.length;
                
                if (currentCount + files.length > maxImages) {
                    alert(`每个产品最多只能上传${maxImages}张图片。您已经上传了${currentCount}张。`);
                    return;
                }
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // 检查文件类型
                    if (!file.type.match('image.*')) {
                        alert(`文件 "${file.name}" 不是图片格式，已跳过。`);
                        continue;
                    }
                    
                    // 检查文件大小（限制为5MB）
                    if (file.size > 5 * 1024 * 1024) {
                        alert(`图片 "${file.name}" 太大（超过5MB），已跳过。`);
                        continue;
                    }
                    
                    try {
                        // 显示加载提示
                        const loadingMsg = document.createElement('div');
                        loadingMsg.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 正在压缩图片 "${file.name}"...`;
                        loadingMsg.style.cssText = 'color: #3498db; font-size: 0.85rem; margin: 5px 0;';
                        previewContainer.appendChild(loadingMsg);
                        
                        // 压缩图片
                        const compressedImage = await compressImage(file, 96, 96, 0.8);
                        
                        // 移除加载提示
                        loadingMsg.remove();
                        
                        // 添加到产品图片数组
                        productRow.productImages.push(compressedImage);
                        
                        // 创建预览
                        const imageIndex = productRow.productImages.length - 1;
                        const previewItem = document.createElement('div');
                        previewItem.className = 'image-preview-item';
                        previewItem.innerHTML = `
                            <img src="${compressedImage}" alt="产品图片 ${imageIndex + 1}">
                            <button type="button" class="remove-image-btn" data-index="${imageIndex}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        
                        // 添加删除按钮事件
                        const removeBtn = previewItem.querySelector('.remove-image-btn');
                        removeBtn.addEventListener('click', function() {
                            const index = parseInt(this.getAttribute('data-index'));
                            productRow.productImages.splice(index, 1);
                            previewItem.remove();
                            
                            // 重新索引剩余的图片
                            const remainingPreviews = previewContainer.querySelectorAll('.image-preview-item');
                            remainingPreviews.forEach((preview, idx) => {
                                const btn = preview.querySelector('.remove-image-btn');
                                btn.setAttribute('data-index', idx);
                            });
                        });
                        
                        previewContainer.appendChild(previewItem);
                        
                    } catch (error) {
                        console.error('图片压缩失败:', error);
                        alert(`图片 "${file.name}" 处理失败，请重试。`);
                    }
                }
            }
            
            // 为已有的图片添加删除事件
            const existingRemoveBtns = productRow.querySelectorAll('.remove-image-btn');
            existingRemoveBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    productRow.productImages.splice(index, 1);
                    this.closest('.image-preview-item').remove();
                    
                    // 重新索引剩余的图片
                    const remainingPreviews = previewContainer.querySelectorAll('.image-preview-item');
                    remainingPreviews.forEach((preview, idx) => {
                        const btn = preview.querySelector('.remove-image-btn');
                        btn.setAttribute('data-index', idx);
                    });
                });
            });
        }
        
        // 更新预览函数
        function updateInvoicePreview() {
            const toCompany = document.getElementById('toCompany').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const attnName = document.getElementById('attnName').value;
            const attnPhone = document.getElementById('attnPhone').value;
            const sellerName = document.getElementById('sellerName').value;
            const sellerPhone = document.getElementById('sellerPhone').value;
            const shipmentTerms = document.getElementById('shipmentTerms').value;
            const paymentTerms = document.getElementById('paymentTerms').value;
            const leadTime = document.getElementById('leadTime').value;
            const exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 7.08;
            
            // 收集产品数据
            const products = [];
            const productRows = document.querySelectorAll('.product-item');
            let totalAmount = 0;
            
            productRows.forEach(row => {
                const product = {
                    model: row.querySelector('.product-model').value,
                    pic: row.querySelector('.product-pic').value,
                    itemName: row.querySelector('.product-item-name').value,
                    specification: row.querySelector('.product-specification').value,
                    exw: row.querySelector('.product-exw').value,
                    qty: row.querySelector('.product-qty').value,
                    units: row.querySelector('.product-units').value,
                    amount: row.querySelector('.product-amount').value,
                    remark: row.querySelector('.product-remark').value,
                    images: row.productImages || []
                };
                products.push(product);
                
                // 计算总金额
                const amount = parseFloat(product.amount.replace(/[^0-9.-]+/g, "")) || 0;
                totalAmount += amount;
            });
            
            // 格式化日期
            const formattedDate = formatDate(invoiceDate);
            
            // 计算人民币总金额
            const totalAmountCNY = totalAmount * exchangeRate;
            
            // 构建预览HTML
            const previewHTML = `
                <div class="invoice-header">
                    <div class="company-name">FOSHAN KEMEI NEW MATERIALS CO.,LTD</div>
                    <div class="company-address">Building 1,Floor 1-3,No.14 Luhu Road,Lubao Town, Sanshui District, Foshan City</div>
                </div>
                
                <div class="invoice-title">PROFORMA INVOICE</div>
                
                <div class="invoice-info">
                    <div><strong>TO:</strong> ${escapeHtml(toCompany)}</div>
                    <div><strong>DATE:</strong> ${formattedDate}</div>
                    <div><strong>INVOICE NO.:</strong> ${escapeHtml(invoiceNumber)}</div>
                </div>
                
                <div class="contact-info">
                    <div><strong>Attn.:</strong> ${escapeHtml(attnName)} &nbsp; ${escapeHtml(attnPhone)}</div>
                    <div><strong>Seller:</strong> ${escapeHtml(sellerName)} &nbsp; ${escapeHtml(sellerPhone)}</div>
                </div>
                
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>Model</th>
                            <th>PIC</th>
                            <th>Item Name</th>
                            <th>Specification</th>
                            <th>EXW USD</th>
                            <th>Q'TY</th>
                            <th>UNITS</th>
                            <th>AMOUNT USD</th>
                            <th>Picture</th>
                            <th>Remark</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products.map((product, index) => {
                            // 检查是否应该合并规格列
                            const specColspan = product.specification ? '' : 'colspan="2"';
                            const specCell = product.specification 
                                ? `<td>${escapeHtml(product.specification)}</td>` 
                                : '';
                            
                            // 生成图片HTML
                            let imagesHTML = '';
                            if (product.images && product.images.length > 0) {
                                imagesHTML = product.images.map(img => 
                                    `<img src="${img}" alt="产品图片" style="margin-bottom: 2px;">`
                                ).join('<br>');
                            }
                            
                            return `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${escapeHtml(product.model)}</td>
                                    <td>${escapeHtml(product.pic)}</td>
                                    ${product.specification ? `<td>${escapeHtml(product.itemName)}</td>` : `<td ${specColspan}>${escapeHtml(product.itemName)}</td>`}
                                    ${specCell}
                                    <td>$${escapeHtml(product.exw)}</td>
                                    <td>${escapeHtml(product.qty)}</td>
                                    <td>${escapeHtml(product.units)}</td>
                                    <td>$${escapeHtml(product.amount)}</td>
                                    <td class="product-image-cell">${imagesHTML}</td>
                                    <td>${escapeHtml(product.remark)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                
                <div class="exchange-rate-display">
                    汇率: 1 USD = ${exchangeRate.toFixed(4)} CNY
                </div>
                
                <div class="total-section">
                    <div><strong>Total Amount</strong> $${totalAmount.toFixed(2)}</div>
                    <div><strong>Total Amount</strong> ¥${totalAmountCNY.toFixed(2)}</div>
                </div>
                
                <div class="terms-section">
                    <p>1. Shipment: ${escapeHtml(shipmentTerms)}</p>
                    <p>2. Payment: ${escapeHtml(paymentTerms)}</p>
                    <p>3. Leadtime: ${escapeHtml(leadTime)}</p>
                    <div class="bank-details">
                        <p>4. Bank details informations:</p>
                        <p>BANK NAME : BANK OF CHINA,SANSHUI SUB-BRANCH<br>
                        BANK ADD: NO,37 LEPING DADAO LEPING TOWN SANSHUI, FOSHAN CITY, GUANGDONG, CHINA.<br>
                        SWIFT CODE: BKCHCNBJ44C<br>
                        Beneficiary's A/C NO.: 727680571125 FOR USD<br>
                        BENEFICIARY NAME : FOSHAN KEMEI NEW MATERIALS CO., LTD<br>
                        BENEFICIARY ADD: Building 1,Floor 1-3,No.14 Luhu Road,Lubao Town,Sanshui District,Foshan City</p>
                    </div>
                </div>
            `;
            
            document.getElementById('invoicePreview').innerHTML = previewHTML;
        }
        
        // 格式化日期函数
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }
        
        // HTML转义函数
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        // 下载发票为图片
        function downloadInvoiceAsImage() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';
            
            // 获取预览元素
            const previewContainer = document.getElementById('previewContainer');
            const invoiceElement = document.getElementById('invoicePreview');
            
            // 为生成图片添加额外的内边距类
            previewContainer.classList.add('printable');
            
            // 使用html2canvas将预览转换为图片
            html2canvas(invoiceElement, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false,
                width: invoiceElement.offsetWidth + 80, // 增加宽度
                height: invoiceElement.offsetHeight + 80, // 增加高度
                windowWidth: invoiceElement.scrollWidth + 80,
                windowHeight: invoiceElement.scrollHeight + 80
            }).then(canvas => {
                // 创建下载链接
                const link = document.createElement('a');
                link.download = `Proforma-Invoice-${document.getElementById('invoiceNumber').value}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                // 移除打印样式类
                previewContainer.classList.remove('printable');
                
                loadingIndicator.style.display = 'none';
            }).catch(error => {
                console.error('生成图片时出错:', error);
                alert('生成图片时出错，请重试。错误信息: ' + error.message);
                previewContainer.classList.remove('printable');
                loadingIndicator.style.display = 'none';
            });
        }
    });
    </script>
</body>
</html>
